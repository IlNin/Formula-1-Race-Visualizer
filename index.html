<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html;charset=utf-8">
        <title>Formula 1 VA Project</title>
        <script type="text/javascript" src="d3.js" charset="utf-8"></script>
        <style>
            #title {
                border: 3px solid black;
                padding-left: 5px;
                padding-right: 5px;
                padding-bottom: 5px;
                display: inline-block;
                background: yellow;
                text-align: center;
            }
            #wrapper {
                display: flex;
                border: 3px solid black;
                border-top: 1px solid black;
                width: fit-content;
            }  
            #timeseries {
                display: inline-block;
            }
            #legendtable {
                display: inline-block;
            }
        </style>
	</head>
    
    <body>
    <script charset="utf-8">
    function init() {
        title = document.createElement('div');
        title.id = "title";
        title.innerHTML = "<h1>Formula 1 Visual Analytics Project</h1>";
        title.innerHTML += "Please select a race: ";
        document.body.appendChild(title);
    
        selectSeason = document.createElement('select');
        selectSeason.id = "select-season";
        defaultSeasonOption = document.createElement('option');
        defaultSeasonOption.value = 0;
        defaultSeasonOption.innerHTML = "- SEASON -";
        selectSeason.appendChild(defaultSeasonOption);
        title.appendChild(selectSeason);
        title.innerHTML += "&nbsp";
    
        selectRace = document.createElement('select');
        selectRace.id = "select-race";
        selectRace.style.width = '150px';
        defaultRaceOption = document.createElement('option');
        defaultRaceOption.value = 0;
        defaultRaceOption.innerHTML = "- RACE -";
        selectRace.appendChild(defaultRaceOption);
        title.appendChild(selectRace);
        title.innerHTML += "&nbsp";
    
        search = document.createElement('button');
        search.id = "search";
        search.innerHTML = "Search data!";
        search.disabled = true;
        title.appendChild(search);
        
        d3.csv("lapsLight.csv", function(data) {
            seasons = [];
            data.forEach(function(d) {
                //console.log(d);
                if (!seasons.includes(d.year)) {
                    seasons.push(d.year);
                    newSeasonOption = document.createElement('option');
                    newSeasonOption.value = d.year;
                    newSeasonOption.innerHTML = d.year;
                    document.getElementById("select-season").appendChild(newSeasonOption);
                }
                document.getElementById("select-season").onchange = function() {loadRaces(data)};    
                document.getElementById("select-race").onchange = function() {ready()};
                search.onclick = function() {plotGraphs(data, document.getElementById("select-season").value, document.getElementById("select-race").value)}
            });
        });
    }
    
    function loadRaces(data) {
        // RESTORE SELECTOR
        document.getElementById("search").disabled = true; // Disables the search button
        document.getElementById("select-race").value = 0; // Restore the race selector to the default option
        options = document.getElementById("select-race").options.length; // Removes all options inside the selector bar the default one
        for (i = options-1; i > 0; i--) {
            document.getElementById("select-race").options[i] = null;
        }
          
        // REFRESH SELECTOR
        year = document.getElementById("select-season").value; // Gets the year selected
        if (year > 0) { // A valid year, that is not the default option, is selected
            races = []; // Keeps track of unique races
            data.forEach(function(d) { // Goes through the data again to get all unique races for the year selected
                if (d.year == year && !races.includes(d.race)) {
                    races.push(d.race);
                    newRaceOption = document.createElement('option');
                    newRaceOption.value = d.round;
                    newRaceOption.innerHTML = d.race;
                    document.getElementById("select-race").appendChild(newRaceOption);
                }
            });
            
        }
    }

    function ready() {
        if (document.getElementById("select-race").value > 0) {  // A valid race is selected: enables search button
            document.getElementById("search").disabled = false;
        }
        else { // Default option selected: disables search button
            document.getElementById("search").disabled = true;
        }
    }
    
    function plotGraphs(data, year, round) {
        // Removes the previous graph
        previousGraph = document.getElementById("wrapper");
        if (document.body.contains(previousGraph)) {
            previousGraph.remove();
        }
    
        // Initializes the dimensions
        container_dimensions = {width: 1050, height: 400}; // width: 650
        margins = {top: 10, right: 20, bottom: 40, left: 40};
        chart_dimensions = {
            width: container_dimensions.width - margins.left - margins.right,
            height: container_dimensions.height - margins.top - margins.bottom
        };
        
        // Gets the relevant data
        relevantData = [];
        drivers = [];
        lineData = new Map();
        data.forEach(function(d) {
            if (d.year == year && d.round == round) {
                relevantData.push(d);
                if (!drivers.includes(d.surname)) {
                    driverData = [];
                    drivers.push(d.surname);
                    lineData.set(d.surname, driverData);
                }
                lineData.get(d.surname).push(d);
            }
        });
        
        // Initializes the wrapper and the empty svg area
        wrapper = document.createElement('div');
        wrapper.id = "wrapper";
        document.body.append(wrapper);
        
        svgDiv = document.createElement('div');
        svgDiv.id = "timeseries";
        wrapper.append(svgDiv);
        
        svg = d3.select('#timeseries')
            .append('svg')
                .attr("width", container_dimensions.width)
                .attr("height", container_dimensions.height)
                //.style("background-color", "red")
            .append("g")
                .attr("transform", "translate(" + margins.left + "," + margins.top + ")")
                .attr("id","timeseries");
        
        // Initializes the scales and colors
        x = d3.scaleLinear()
            .domain(d3.extent(relevantData, function(d) {
                    return +d.lap;
                    }))
            .range([0, chart_dimensions.width])
            
        y = d3.scaleLinear()
            .domain(d3.extent(relevantData, function(d) {
                    return +d.position;
                    }))
            .range([0, chart_dimensions.height]);
        
        colors = d3.scaleOrdinal(d3.schemeCategory20);
            
        // Initializes the axis
        xAxis= d3.axisBottom(x).ticks().tickFormat(d3.format("d"));
        yAxis= d3.axisLeft(y).ticks(20).tickFormat(d3.format("d"));
        
        // Appends the x axis
        svg.append("g")
            .attr("class","x axis")
            .attr("transform", "translate(0,"+(chart_dimensions.height+1)+")")
            .call(xAxis);
        svg.append("text")
            .attr("class","label")
            .attr("x", chart_dimensions.width)
            .attr("y", chart_dimensions.height+(margins.bottom-10))
            .style("text-anchor","end")
            .text("Laps");
        
        // Appends the y axis
        svg.append("g")
            .attr("class","y axis")
            .call(yAxis)
        svg.append("text")
            .attr("class","label")
            .attr("transform","rotate(-90)")
            .attr("y", 6)
            .attr("dy","-1.5em")
            .style("text-anchor","end")
            .text("Position");
        
        // Populates the chart        
        svg.selectAll("circle")
            .data(relevantData)
            .enter()
            .append("circle")
            .attr("class", function(d) {
                return "dot"+d.surname; 
            })
            .attr("r", 1)
            .attr("cx", function(d) { 
                return x(d.lap);
            })
            .attr("cy", function(d) { 
                return y(d.position);
            })
            .style("fill", function(d) {
                return colors(d.surname); 
            });
            
        // Draws the line that connects the points
        line = d3.line()
            .x(function(d){return x(d.lap)})
            .y(function(d){return y(d.position)})
            .curve(d3.curveLinear);
        for (i = 0; i < drivers.length; i++) {
            color = colors(drivers[i]);
            svg.append('path')
                .attr("class", "path"+drivers[i])
                .attr('d', line(lineData.get(drivers[i])))
                .attr("fill", "none")
                .attr("stroke-width", 1)
                .attr("stroke", color);
        }
        
        // Draws the legend
        svgLegendDiv = document.createElement('div');
        svgLegendDiv.id = "legendtable";
        wrapper.append(svgLegendDiv);
        
        svgLegend = d3.select('#legendtable')
            .append('svg')
            .attr("width", 110)
            .attr("height", container_dimensions.height)
            //.style("background-color", "red")
            .append("g")
            .attr("transform", "translate(" + 0 + "," + margins.top + ")")
            .attr("id","legendtable");
          
        sizeSquare = 10;
        legend = svgLegend.selectAll("legend")
            .data(drivers)
            .enter()
            .append("g")
            .attr("class", "legend")
			.attr("transform", function(d,i){
                return "translate(0,"+(i*sizeSquare+i*6)+")";
            });
        legend.append("rect")
			.attr("width",sizeSquare)
			.attr("height",sizeSquare)
            .attr("class", function(d) {
                return "rect"+d;
            })
			.style("fill", function(d){
                return colors(d);
			});
            
        // Writes text on the legend
        legend.append("text")
            .attr("class", function(d) {
                return "text"+d;
            })
            .attr("x", sizeSquare+5)
            .attr("y", sizeSquare/2)
            .attr("dy", ".35em")
            .text(function(d) {
                return d;
            })
            .on("click", function(d) { // User disables/enables data of a pilot in the graph
                // DISABLE
                if (d3.select(".path"+d).attr("visibility") == "visible") {
                    d3.selectAll(".dot"+d)
                        .attr("visibility", "hidden");
                    d3.select(".path"+d)
                        .attr("visibility", "hidden");
                    d3.select(".text"+d)
                        .style("fill", "grey");
                    d3.select(".rect"+d)
                        .style("fill", "grey");
                }
                // ENABLE
                else {
                    d3.selectAll(".dot"+d)
                        .attr("visibility", "visible");
                    d3.select(".path"+d)
                        .attr("visibility", "visible");
                    d3.select(".text"+d)
                        .style("fill", "black");
                    d3.select(".rect"+d)
                        .style("fill", colors(d));
                }   
            });
        
    }
    
    init();
    </script>
    </body>
</html>